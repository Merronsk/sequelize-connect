{"version":3,"sources":["../../src/Discoverable.js"],"names":["fs","Promise","promisifyAll","f","Discoverable","paths","matcher","logger","discovered","each","location","_dive","then","results","_log","filter","value","dir","readdirAsync","map","file","path","stat","statSync","isDirectory","test","level","message","log","module","exports"],"mappings":";;;;AAAA;;;;AACA;;;;AACA;;;;;;;;AAEA,IAAIA,KAAKC,mBAAQC,YAAR,CAAqBC,YAArB,CAAT;;IAEMC,Y;AAEJ,wBAAYC,KAAZ,EAAmBC,OAAnB,EAAyC;AAAA,QAAbC,MAAa,uEAAN,KAAM;;AAAA;;AACvC,SAAKF,KAAL,GAAaA,KAAb;AACA,SAAKC,OAAL,GAAeA,OAAf;AACA,SAAKC,MAAL,GAAcA,MAAd;AACD;;AAED;;;;;;;;;;+BAMW;AAAA;;AAET,UAAIC,aAAa,EAAjB;;AAEA,aAAOP,mBAAQQ,IAAR,CAAa,KAAKJ,KAAlB,EAAyB,UAACK,QAAD,EAAc;;AAE5C;AACA,eAAO,MAAKC,KAAL,CAAWD,QAAX,EACJE,IADI,CACC,UAACC,OAAD,EAAa;AACjB,gBAAKC,IAAL,CAAU,OAAV,EAAmB,oBAAnB;AACA,iBAAO,sBAAQD,OAAR,EAAiB,IAAjB,CAAP;AACD,SAJI,EAKJE,MALI,CAKG,UAACC,KAAD,EAAW;AACjB,iBAAOA,UAAU,KAAjB;AACD,SAPI,EAQJJ,IARI,CAQC,UAACC,OAAD,EAAa;AACjB,gBAAKC,IAAL,CAAU,OAAV,EAAmB,6CAA6CD,OAAhE;AACA,iBAAOL,aAAaK,OAApB;AACD,SAXI,CAAP;AAaD,OAhBM,EAgBJD,IAhBI,CAgBC,YAAM;AACZ,eAAOJ,UAAP;AACD,OAlBM,CAAP;AAmBD;;AAED;;;;;;;;0BAKMS,G,EAAK;AAAA;;AAET;AACA,aAAOjB,GAAGkB,YAAH,CAAgBD,GAAhB,EAAqBE,GAArB,CAAyB,UAACC,IAAD,EAAU;AACxC,YAAIC,OAAOJ,MAAM,GAAN,GAAYG,IAAvB,CADwC,CACV;AAC9B,YAAIE,OAAOtB,GAAGuB,QAAH,CAAYF,IAAZ,CAAX,CAFwC,CAEV;;AAE9B;AACA,YAAIC,QAAQA,KAAKE,WAAL,EAAZ,EAAgC;AAC9B,iBAAO,OAAKb,KAAL,CAAWU,IAAX,CAAP,CAD8B,CACL;AAC1B,SAFD,MAEO;AACL;AACA,cAAG,OAAO,OAAKf,OAAZ,KAAwB,UAAxB,IAAsC,OAAKA,OAAL,CAAac,IAAb,MAAuB,IAAhE,EAAsE;AACpE,mBAAKN,IAAL,CAAU,OAAV,EAAmB,sBAAsBO,IAAzC;AACA,mBAAOA,IAAP;AACD,WAHD,MAGO,IAAG,uBAAuBI,IAAvB,CAA4BL,IAA5B,CAAH,EAAsC;AAC3C,mBAAKN,IAAL,CAAU,OAAV,EAAmB,sBAAsBO,IAAzC;AACA,mBAAOA,IAAP;AACD;;AAED,iBAAO,KAAP;AACD;AACF,OAnBM,CAAP;AAqBD;;AAED;;;;;;;;yBAKKK,K,EAAOC,O,EAAQ;AAClB,WAAKpB,MAAL,GAAc,KAAKA,MAAL,CAAYqB,GAAZ,CAAgBF,KAAhB,EAAuBC,OAAvB,CAAd,GAAgD,KAAhD;AACD;;;;;;AAGHE,OAAOC,OAAP,GAAkB1B,YAAlB","file":"Discoverable.js","sourcesContent":["import Promise from \"bluebird\";\r\nimport flatten from \"lodash.flatten\";\r\nimport f from \"fs\";\r\n\r\nlet fs = Promise.promisifyAll(f);\r\n\r\nclass Discoverable {\r\n\r\n  constructor(paths, matcher, logger=false){\r\n    this.paths = paths;\r\n    this.matcher = matcher;\r\n    this.logger = logger;\r\n  }\r\n\r\n  /**\r\n   * Discover the specified path for files\r\n   * matching the given convention\r\n   *\r\n   * @return {Array} The array of matching files for the discoverable directories\r\n   */\r\n  discover() {\r\n\r\n    let discovered = [];\r\n\r\n    return Promise.each(this.paths, (location) => {\r\n\r\n      // Recurse through the api directory and collect the models\r\n      return this._dive(location)\r\n        .then((results) => {\r\n          this._log(\"debug\", \"Flattening results\");\r\n          return flatten(results, true);\r\n        })\r\n        .filter((value) => {\r\n          return value !== false\r\n        })\r\n        .then((results) => {\r\n          this._log(\"debug\", \"Assigning filtered results to discover: \" + results);\r\n          return discovered = results;\r\n        });\r\n\r\n    }).then(() => {\r\n      return discovered;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * [dive description]\r\n   * @param  {String} dir The directory to recurse through\r\n   * @return {Array}     An array of matching files at the given location\r\n   */\r\n  _dive(dir) {\r\n\r\n    // Read the directory\r\n    return fs.readdirAsync(dir).map((file) => {\r\n      let path = dir + \"/\" + file;  // Full path of that file\r\n      let stat = fs.statSync(path); // Get the file's stats\r\n\r\n      // If the file is a directory\r\n      if (stat && stat.isDirectory()) {\r\n        return this._dive(path); // Dive into the directory\r\n      } else {\r\n        // Allow user to define a custom matcher function\r\n        if(typeof this.matcher === 'function' && this.matcher(file) === true) {\r\n          this._log(\"debug\", \"Discovered path: \" + path);\r\n          return path;\r\n        } else if(/^[^.].*?\\.model\\.js$/.test(file)) {\r\n          this._log(\"debug\", \"Discovered path: \" + path);\r\n          return path;\r\n        }\r\n\r\n        return false;\r\n      }\r\n    });\r\n\r\n  }\r\n\r\n  /**\r\n   * Attempt to log\r\n   * @param  {String} message Message to log\r\n   * @return {null}\r\n   */\r\n  _log(level, message){\r\n    this.logger ? this.logger.log(level, message) : false;\r\n  }\r\n}\r\n\r\nmodule.exports =  Discoverable;\r\n"]}